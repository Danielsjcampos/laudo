// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Clinic {
  id                 String   @id @default(cuid())
  name               String
  location           String
  subscriptionStatus String   // 'Ativa' | 'Atrasada' | 'Cancelada'
  monthlyFee         Float
  examCount          Int      @default(0)
  joinedDate         DateTime @default(now())
  adminEmail         String   @unique
  patients           Patient[]
  exams              Exam[]
}

model Doctor {
  id            String   @id @default(cuid())
  name          String
  crm           String   @unique
  specialty     String
  status        String   @default("Pendente") // 'Ativo' | 'Pendente'
  joinedDate    DateTime @default(now())
  rating        Float    @default(0)
  exams         Exam[]
}

model Patient {
  id        String   @id @default(cuid())
  name      String
  cpf       String   @unique
  email     String   @unique
  sex       String?  // 'M' | 'F'
  clinicId  String
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  exams     Exam[]
}

model Exam {
  id                 String   @id @default(cuid())
  patientId          String
  patientName        String
  doctorAssignedId   String?
  doctorAssignedName String?
  examType           String
  modality           String   // 'RX' | 'TC' | 'RM' | 'US' | 'MG' | 'OT'
  urgency            String   // 'Rotina' | 'Urgente'
  bodyPart           String?
  accessionNumber    String?  @unique
  specialtyRequired  String
  dateRequested      DateTime @default(now())
  status             String   // 'Disponível' | 'Aguardando Laudo' | 'Laudando' | 'Em Análise' | 'Concluído' | 'Recusado'
  price              Float
  clinicName         String
  clinicId           String
  clinic             Clinic   @relation(fields: [clinicId], references: [id])
  patient            Patient  @relation(fields: [patientId], references: [id])
  doctor             Doctor?  @relation(fields: [doctorAssignedId], references: [id])
  paymentStatus      String   // 'Pendente' | 'Pago' | 'Processando'
  examImageUrl       String?
  aiDraft            String?
  finalReport        String?
  aiInsights         String?
  externalSuggestion String? // Sugestão salva via link de segunda opinião (Shared View)
  dicomUrl           String?
  medicalRequestUrl  String?
  studyInstanceUID   String?
  clinicalHistory    String?
  preReportTemplateId String?
  preReportTemplate   PreReportTemplate? @relation(fields: [preReportTemplateId], references: [id])
}

model GlobalStats {
  id                  Int      @id @default(1)
  totalRevenue        Float
  totalTransferred    Float
  platformProfit      Float
  totalExamsProcessed Int
  activeClinics       Int
  totalDoctors        Int
  monthlyGrowth       Float
  marketplaceTax      Float
  saasRevenue         Float
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      String   // 'admin' | 'clinic' | 'doctor' | 'patient'
  password  String   // In a real app, hash this
  createdAt DateTime @default(now())
}

model PricingTable {
  id              String   @id @default(cuid())
  modality        String   // 'RX', 'TC', 'RM', 'US', 'MG', 'OT'
  urgency         String   // 'Rotina', 'Urgente'
  price           Float
  updatedAt       DateTime @default(now()) @updatedAt

  @@unique([modality, urgency])
}


model SystemSettings {
  id        String   @id @default(cuid())
  feeGlobal Float    @default(15.0)
  feeDev    Float    @default(5.0)
  updatedAt DateTime @default(now()) @updatedAt
}

model PreReportTemplate {
  id          String   @id @default(cuid())
  title       String
  modality    String   // 'RX', 'TC', 'RM', 'US', 'MG', 'OT'
  bodyRegion  String
  complexity  Int      @default(1)
  sections    String   // Stored as JSON string
  variants    String?  // Stored as JSON string
  targetSex   String?  // 'M' | 'F' (null means both)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  exams       Exam[]
}

model VerifiedCrm {
  id            String   @id @default(cuid())
  crm           String
  uf            String
  name          String
  specialty     String?
  status        String   // 'Ativo' | 'Inativo' | 'Cancelado'
  source        String   // 'Official' | 'ThirdParty' | 'Manual'
  lastVerified  DateTime @default(now())
  metadata      String?  // JSON string for extra info from sources

  @@unique([crm, uf])
}

